pipeline {
  agent {
    kubernetes {
      yaml """
  spec:
    serviceAccountName: jenkins-deployer
    containers:
    - name: tools
      image: ghcr.io/sandip84/jenkins-agent-tools:v0.1.3
      imagePullPolicy: Always
      command:
      - cat
      tty: true    
      env:    
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: AWS_ACCESS_KEY_ID
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: AWS_SECRET_ACCESS_KEY
      - name: AWS_REGION
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: AWS_REGION        
  """
    }
  }

  parameters {
    string(name: 'IMAGE_TAG', defaultValue: '20', description: 'ECR tag produced by CI (example: git-fea78db or 123)')
    choice(name: 'ENV', choices: ['kind'], description: 'Target cluster/env (extend later: dev/stage/prod)')
    booleanParam(name: 'REFRESH_ECR_PULL_SECRET', defaultValue: true, description: 'Refresh ecr-secret in the target namespace')
  }
// @Library('jenkins-shared-lib') _
// pipeline {
//   agent {
//     kubernetes {
//       yaml javaKanikoAgent(
//         mavenImage: "maven:3.9.6-eclipse-temurin-17",
//         kanikoImage: "gcr.io/kaniko-project/executor:debug"
//       )
//     }
//   }
  environment {
    GIT_REPO    = "https://github.com/sandip84/k8s.git"
    GIT_BRANCH  = "main"   
    AWS_REGION  = "us-east-1"
    AWS_ACCOUNT = "168400405045"
    ECR_REPO    = "java-app"
    ECR_URI     = "${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
    K8S_NAMESPACE = "java-app-ns"          // change if you use default
    APP_NAME      = "java-app"          // Deployment name
  }

  stages {

    stage('Checkout CD Repo') {
      steps {
        git branch: "${GIT_BRANCH}",
            url: "${GIT_REPO}"
      }
    }

    stage('Validate Inputs') {
      steps {
        script {
          if (!params.IMAGE_TAG?.trim()) {
            error("IMAGE_TAG is required (example: git-fea78db).")
          }
        }
      }
    }

    stage('Verify Image Exists in  ECR') {
      steps {
        container('tools') {
          sh """
            aws ecr describe-images \
              --region ${AWS_REGION} \
              --repository-name ${ECR_REPO} \
              --image-ids imageTag=${params.IMAGE_TAG} \
              --query 'imageDetails[0].imageDigest' \
              --output text
          """
        }
      }
    }

    stage('Create Namespace (YAML)') {
      steps {
        container('tools') {
          sh """
            kubectl apply -f namespace.yaml
            # kubectl apply -f ServiceAccount.yaml
          """
        }  
      }
    }

    stage('Refresh ECR Pull Secret (Kind)') {
      when { expression { return params.REFRESH_ECR_PULL_SECRET } }
      steps {
        container('tools') {
          sh """
            #TOKEN=\$(aws ecr get-login-password --region ${AWS_REGION})

            #kubectl delete secret ecr-secret -n ${K8S_NAMESPACE} --ignore-not-found
            #kubectl create secret docker-registry ecr-secret \
            #  -n ${K8S_NAMESPACE} \
            #  --docker-server=${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com \
            #  --docker-username=AWS \
            #  --docker-password-stdin \
            #  --dry-run=client -o yaml | kubectl apply -f -

            aws ecr get-login-password --region ${AWS_REGION} | \
            sed "s|^|{\"auths\":{\"${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com\":{\"username\":\"AWS\",\"password\":\"|;s|$|\"}}}|" \
            > /tmp/config.json

            kubectl create secret generic ecr-secret \
              -n ${K8S_NAMESPACE} \
              --from-file=.dockerconfigjson=/tmp/config.json \
              --type=kubernetes.io/dockerconfigjson \
              --dry-run=client -o yaml | kubectl apply -f -


          """
        }
      }
    }

    stage('Render Manifests with Image') {
      steps {
        sh """
          mkdir -p rendered

          # Render deployment with correct image without modifying tracked file
          sed "s|REPLACE_IMAGE|${ECR_URI}:${params.IMAGE_TAG}|g" deployment.yaml > rendered/deployment.yaml

          # Copy other manifests as-is
          cp service.yaml rendered/service.yaml
          cp namespace.yaml rendered/namespace.yaml
        """
      }
    }

    stage('Apply to Kubernetes') {
      steps {
        container('tools') {
          sh """
            kubectl apply -f rendered/namespace.yaml
            kubectl apply -f rendered/deployment.yaml
            kubectl apply -f rendered/service.yaml
          """
        }
      }
    }

    // stage('Wait for Rollout') {
    //   steps {
    //     container('tools') {
    //       sh """
    //         kubectl rollout status deployment/${APP_NAME} -n ${K8S_NAMESPACE} --timeout=180s
    //         kubectl get pods -n ${K8S_NAMESPACE} -o wide
    //         kubectl get svc  -n ${K8S_NAMESPACE} -o wide
    //       """
    //     }
    //   }
    // }

    stage('Wait for Rollout') {
      steps {
        container('tools') {
          sh """
            kubectl rollout status deployment/${APP_NAME} -n ${K8S_NAMESPACE} --timeout=180s || true
            kubectl get pods -n ${K8S_NAMESPACE}
            kubectl describe deployment ${APP_NAME} -n ${K8S_NAMESPACE}
          """
        }
      }
    }
  }
}


